{% extends 'base.html' %}
{% block title %}Informe de Producci√≥n de Piezas{% endblock %}
{% block content %}

<h2 class="mb-4 text-center">üß© Informe de Producci√≥n de Piezas</h2>

<div class="card bg-dark border-light shadow-lg mx-auto" style="max-width: 1100px;">
  <div class="card-body">

    <!-- Filtros -->
    <form method="POST" action="{{ url_for('informe_piezas') }}" class="row g-3 align-items-end mb-4">
      <div class="col-md-3">
        <label class="form-label text-light">Desde:</label>
        <input type="date" class="form-control bg-secondary text-light" name="fecha_inicio"
               value="{{ fecha_inicio or '' }}">
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Hasta:</label>
        <input type="date" class="form-control bg-secondary text-light" name="fecha_fin"
               value="{{ fecha_fin or '' }}">
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Estado:</label>
        <select name="estado" class="form-select bg-secondary text-light">
          <option value="todos" {% if estado_sel == 'todos' or not estado_sel %}selected{% endif %}>Todos</option>
          <option value="pendiente" {% if estado_sel == 'pendiente' %}selected{% endif %}>Pendiente</option>
          <option value="aprobado" {% if estado_sel == 'aprobado' %}selected{% endif %}>Aprobado</option>
          <option value="rechazado" {% if estado_sel == 'rechazado' %}selected{% endif %}>Rechazado</option>
        </select>
      </div>

      <div class="col-md-3 text-end">
        <button type="submit" class="btn btn-accent w-100">Filtrar</button>
      </div>
    </form>

    {% if piezas %}
    <!-- Exportar -->
    <form method="POST" action="{{ url_for('exportar_piezas_excel') }}">
      <input type="hidden" name="fecha_inicio" value="{{ fecha_inicio or '' }}">
      <input type="hidden" name="fecha_fin" value="{{ fecha_fin or '' }}">
      <input type="hidden" name="estado" value="{{ estado_sel or 'todos' }}">
      <div class="text-end mb-3">
        <button type="submit" class="btn btn-success">üì§ Exportar a Excel</button>
      </div>
    </form>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Operador</th>
            <th>C√≥digo</th>
            <th>Modo</th>
            <th>Box</th>
            <th>Marco</th>
            <th>Tramo</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for p in piezas %}
          <tr>
            <td>{{ p.fecha.strftime('%d-%m-%Y %H:%M') }}</td>
            <td>{{ p.usuario }}</td>
            <td>{{ p.codigo_pieza }}</td>
            <td>{{ p.modo|capitalize }}</td>
            <td>{{ p.box }}</td>
            <td>{{ p.marco }}</td>
            <td>{{ p.tramo }}</td>
            <td>
              {% if p.calidad_status == 'aprobado' %}
              <span class="badge bg-success">Aprobado</span>
              {% elif p.calidad_status == 'rechazado' %}
              <span class="badge bg-danger">Rechazado</span>
              {% else %}
              <span class="badge bg-secondary">Pendiente</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- üìä Gr√°fico de barras -->
    <div class="mt-5 text-center">
      <h4 class="text-light mb-3">Distribuci√≥n por Estado</h4>
      <canvas id="estadoChart" style="max-height: 400px;"></canvas>
    </div>

    {% else %}
      <div class="alert alert-secondary text-center">No hay datos disponibles con los filtros actuales.</div>
    {% endif %}
  </div>
</div>

<div class="text-center mt-4">
  <a href="{{ url_for('admin_informes') }}" class="btn btn-secondary px-4">‚Üê Volver a Informes</a>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('estadoChart');
const data = {
  labels: ['Aprobado', 'Rechazado', 'Pendiente'],
  datasets: [{
    label: 'Cantidad de Piezas',
    data: [
      {{ estado_counts['aprobado'] }},
      {{ estado_counts['rechazado'] }},
      {{ estado_counts['pendiente'] }}
    ],
    backgroundColor: ['#4CAF50', '#F44336', '#9E9E9E'],
    borderColor: '#ffffff',
    borderWidth: 1
  }]
};
if (ctx) {
  new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true }
      },
      scales: {
        x: {
          ticks: { color: '#fff' },
          grid: { color: '#444' }
        },
        y: {
          ticks: { color: '#fff', beginAtZero: true },
          grid: { color: '#444' }
        }
      }
    }
  });
}
</script>

{% endblock %}
