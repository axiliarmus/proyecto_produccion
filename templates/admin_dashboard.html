{% extends 'admin_layout.html' %}

{% block title %}Dashboard{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const canvas = document.getElementById('miniEstadoChart');
    if (canvas) {
        const ctxEstado = canvas.getContext('2d');
        new Chart(ctxEstado, {
            type: 'doughnut',
            data: {
                labels: ['Sin Producci√≥n', 'Armado', 'Rematado'],
                datasets: [{
                    data: [
                        {{ stats_piezas.sin_produccion }}, 
                        {{ stats_piezas.armado }}, 
                        {{ stats_piezas.rematado }}
                    ],
                    backgroundColor: [
                        '#6c757d', // secondary
                        '#ffc107', // warning
                        '#198754'  // success
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}"
    }
  ]
}
{% block header_title %}Dashboard{% endblock %}
{% block header_subtitle %}Resumen general del sistema{% endblock %}

{% block content %}
<!-- Stats Row -->
<div class="row g-4 mb-5">
    <!-- Usuarios Card -->
    <div class="col-md-3">
        <div class="admin-card stat-card">
            <div class="stat-icon bg-gradient-1 text-white">
                <i class='bx bxs-user'></i>
            </div>
            <div>
                <div class="stat-title">Total Usuarios</div>
                <div class="stat-value">{{ total_usuarios }}</div>
            </div>
            <a href="{{ url_for('usuarios_list') }}" class="stretched-link"></a>
        </div>
    </div>

    <!-- Boxes Card -->
    <div class="col-md-3">
        <div class="admin-card stat-card">
            <div class="stat-icon bg-gradient-2 text-white">
                <i class='bx bxs-package'></i>
            </div>
            <div>
                <div class="stat-title">Boxes Activos</div>
                <div class="stat-value">{{ total_boxes }}</div>
            </div>
            <a href="{{ url_for('boxes_list') }}" class="stretched-link"></a>
        </div>
    </div>

    <!-- Piezas Card -->
    <div class="col-md-3">
        <div class="admin-card stat-card">
            <div class="stat-icon bg-gradient-3 text-white">
                <i class='bx bxs-extension'></i>
            </div>
            <div>
                <div class="stat-title">Piezas Definidas</div>
                <div class="stat-value">{{ total_piezas }}</div>
            </div>
            <a href="{{ url_for('piezas_list') }}" class="stretched-link"></a>
        </div>
    </div>

    <!-- Producci√≥n Card -->
    <div class="col-md-3">
        <div class="admin-card stat-card">
            <div class="stat-icon bg-primary text-white">
                <i class='bx bxs-bar-chart-alt-2'></i>
            </div>
            <div>
                <div class="stat-title">Registros Prod.</div>
                <div class="stat-value">{{ total_produccion }}</div>
            </div>
            <a href="{{ url_for('admin_informes') }}" class="stretched-link"></a>
        </div>
    </div>
</div>

<!-- =======================
     NUEVOS INDICADORES DE PRODUCCI√ìN Y ESTADO
     ======================= -->
<div class="row g-4 mb-5">
    <!-- Kilos Hoy -->
    <div class="col-md-4">
        <div class="admin-card h-100">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="text-white mb-0">üìÖ Producci√≥n Hoy</h5>
                <span class="badge badge-soft text-success">En tiempo real</span>
            </div>
            <div class="row text-center">
                <div class="col-6 border-end border-secondary">
                    <small class="text-secondary">AVO</small>
                    <h4 class="text-light fw-bold">{{ "%.1f"|format(kilos_hoy.avo) }}</h4>
                </div>
                <div class="col-6">
                    <small class="text-secondary">METRO</small>
                    <h4 class="text-light fw-bold">{{ "%.1f"|format(kilos_hoy.metro) }}</h4>
                </div>
            </div>
            <div class="mt-3 pt-3 border-top border-secondary text-center">
                <small class="text-secondary">TOTAL HOY</small>
                <h3 class="text-accent fw-bold">{{ "%.1f"|format(kilos_hoy.avo + kilos_hoy.metro) }} <small class="fs-6 text-secondary">kg</small></h3>
            </div>
        </div>
    </div>

    <!-- Kilos Mes -->
    <div class="col-md-4">
        <div class="admin-card h-100">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="text-white mb-0">üóìÔ∏è Producci√≥n Mes</h5>
                <span class="badge badge-soft text-info">Acumulado</span>
            </div>
            <div class="row text-center">
                <div class="col-6 border-end border-secondary">
                    <small class="text-secondary">AVO</small>
                    <h4 class="text-light fw-bold">{{ "%.1f"|format(kilos_mes.avo) }}</h4>
                </div>
                <div class="col-6">
                    <small class="text-secondary">METRO</small>
                    <h4 class="text-light fw-bold">{{ "%.1f"|format(kilos_mes.metro) }}</h4>
                </div>
            </div>
            <div class="mt-3 pt-3 border-top border-secondary text-center">
                <small class="text-secondary">TOTAL MES</small>
                <h3 class="text-info fw-bold">{{ "%.1f"|format(kilos_mes.avo + kilos_mes.metro) }} <small class="fs-6 text-secondary">kg</small></h3>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Estado (Miniatura) -->
    <div class="col-md-4">
        <div class="admin-card h-100 position-relative">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="text-white mb-0">Estado Piezas</h5>
                <a href="{{ url_for('informe_estado_piezas') }}" class="btn btn-sm btn-ghost-warning">Ver Detalle</a>
            </div>
            <div style="height: 140px;">
                <canvas id="miniEstadoChart"></canvas>
            </div>
            <div class="d-flex justify-content-around mt-2 small">
                <span class="text-secondary"><i class='bx bxs-circle text-secondary'></i> Sin Prod: {{ stats_piezas.sin_produccion }}</span>
                <span class="text-warning"><i class='bx bxs-circle text-warning'></i> Armado: {{ stats_piezas.armado }}</span>
                <span class="text-success"><i class='bx bxs-circle text-success'></i> Rematado: {{ stats_piezas.rematado }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Main Grid -->
<div class="row g-4">
    <!-- Left Column: Quick Actions & Reports -->
    <div class="col-lg-8">
        <div class="admin-card h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white mb-0">Gesti√≥n R√°pida</h4>
                <span class="badge bg-secondary">Accesos Directos</span>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <a href="{{ url_for('usuarios_nuevo_form') }}" class="btn btn-outline-light w-100 p-3 text-start d-flex align-items-center gap-3">
                        <i class='bx bx-plus-circle fs-4 text-accent'></i>
                        <div>
                            <div class="fw-bold">Nuevo Usuario</div>
                            <small class="text-secondary">Registrar operador o admin</small>
                        </div>
                    </a>
                </div>
                <div class="col-md-6">
                    <a href="{{ url_for('piezas_nuevo_form') }}" class="btn btn-outline-light w-100 p-3 text-start d-flex align-items-center gap-3">
                        <i class='bx bx-plus-circle fs-4 text-warning'></i>
                        <div>
                            <div class="fw-bold">Nueva Pieza</div>
                            <small class="text-secondary">A√±adir al cat√°logo</small>
                        </div>
                    </a>
                </div>
                <div class="col-md-6">
                    <a href="{{ url_for('admin_informes') }}" class="btn btn-outline-light w-100 p-3 text-start d-flex align-items-center gap-3">
                        <i class='bx bx-file fs-4 text-info'></i>
                        <div>
                            <div class="fw-bold">Ver Informes</div>
                            <small class="text-secondary">Producci√≥n, Horarios, Kilos</small>
                        </div>
                    </a>
                </div>
                <div class="col-md-6">
                    <a href="{{ url_for('admin_buscador_piezas') }}" class="btn btn-outline-light w-100 p-3 text-start d-flex align-items-center gap-3">
                        <i class='bx bx-search fs-4 text-success'></i>
                        <div>
                            <div class="fw-bold">Buscador Universal</div>
                            <small class="text-secondary">Rastrear cualquier pieza</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Monthly Cut -->
    <div class="col-lg-4">
        <div class="admin-card bg-dark border-danger h-100">
            <div class="d-flex align-items-center gap-2 mb-3 text-danger">
                <i class='bx bxs-calendar-x fs-3'></i>
                <h5 class="mb-0">Cierre de Mes</h5>
            </div>
            <p class="text-secondary small mb-4">
                Realiza el corte mensual para archivar la producci√≥n actual y reiniciar contadores.
            </p>
            
            <form method="post" action="{{ url_for('admin_corte_mensual') }}">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                
                <div class="mb-3">
                    <label class="form-label text-light small">Nombre del Corte</label>
                    <input type="text" name="nombre" class="form-control bg-dark text-light border-secondary" placeholder="Ej: Enero 2026">
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-light small">Fecha Inicio</label>
                    <input type="date" name="fecha_inicio" class="form-control bg-dark text-light border-secondary" required>
                </div>
                
                <div class="mb-4">
                    <label class="form-label text-light small">Fecha Fin</label>
                    <input type="date" name="fecha_fin" class="form-control bg-dark text-light border-secondary" required>
                </div>
                
                <button class="btn btn-danger w-100 d-flex align-items-center justify-content-center gap-2">
                    <i class='bx bx-archive-in'></i> Ejecutar Corte
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}