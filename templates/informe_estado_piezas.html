{% extends 'base.html' %}
{% block title %}Informe Estado de Piezas{% endblock %}

{% block content %}
<h2 class="mb-4">Informe ‚Äì Estado de Piezas</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="text-secondary mb-0">Ver si cada pieza est√° sin producir, en armado o rematada.</p>
  
  </div>

<!-- ================= GR√ÅFICO DE ESTADO ================= -->
<div class="row mb-4">
    <div class="col-md-6 mx-auto">
        <div class="card bg-dark border-light shadow">
            <div class="card-header border-light text-center">
                <h5 class="card-title text-light mb-0">Resumen de Estado</h5>
            </div>
            <div class="card-body">
                <div style="height: 300px;">
                    <canvas id="estadoChart"></canvas>
                </div>
                
                <!-- Resumen de Totales -->
                <div class="row text-center mt-4 border-top border-secondary pt-3">
                    <div class="col-4 border-end border-secondary">
                        <div class="mb-1">
                            <span class="d-inline-block rounded-circle me-1" style="width: 10px; height: 10px; background-color: #6c757d;"></span>
                            <small class="text-secondary">Sin Prod.</small>
                        </div>
                        <h4 class="text-white fw-bold mb-0">{{ stats.sin_produccion }}</h4>
                    </div>
                    <div class="col-4 border-end border-secondary">
                        <div class="mb-1">
                            <span class="d-inline-block rounded-circle me-1" style="width: 10px; height: 10px; background-color: #ffc107;"></span>
                            <small class="text-warning">Armado</small>
                        </div>
                        <h4 class="text-white fw-bold mb-0">{{ stats.armado }}</h4>
                    </div>
                    <div class="col-4">
                        <div class="mb-1">
                            <span class="d-inline-block rounded-circle me-1" style="width: 10px; height: 10px; background-color: #198754;"></span>
                            <small class="text-success">Rematado</small>
                        </div>
                        <h4 class="text-white fw-bold mb-0">{{ stats.rematado }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= FILTROS ================= -->
<div class="card bg-dark border-light shadow mb-4">
  <div class="card-body">
    <form method="POST" class="row g-3">
      <div class="col-md-3">
        <label class="form-label text-light">Cliente</label>
        <select name="empresa" id="empresa" class="form-select">
          <option value="todos" {% if not empresa_sel or empresa_sel=='todos' %}selected{% endif %}>Todos</option>
          {% for e in empresas %}
            <option value="{{ e }}" {% if empresa_sel==e %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Marco</label>
        <select name="marco" id="marco" class="form-select">
          <option value="todos" {% if not marco_sel or marco_sel=='todos' %}selected{% endif %}>Todos</option>
          {% for m in marcos %}
            <option value="{{ m }}" {% if marco_sel==m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Tramo</label>
        <select name="tramo" id="tramo" class="form-select">
          <option value="todos" {% if not tramo_sel or tramo_sel=='todos' %}selected{% endif %}>Todos</option>
          {% for t in tramos %}
            <option value="{{ t }}" {% if tramo_sel==t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">C√≥digo pieza</label>
        <input type="text" name="codigo_pieza" value="{{ codigo_sel or '' }}" class="form-control" placeholder="Ej: 1001 (vac√≠o = todas)">
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Estado</label>
        <select name="estado" class="form-select">
            <option value="todos" {% if not estado_sel or estado_sel == 'todos' %}selected{% endif %}>Todos</option>
            <option value="Sin producci√≥n" {% if estado_sel == 'Sin producci√≥n' %}selected{% endif %}>Sin producci√≥n</option>
            <option value="Armado" {% if estado_sel == 'Armado' %}selected{% endif %}>Armado</option>
            <option value="Rematado" {% if estado_sel == 'Rematado' %}selected{% endif %}>Rematado</option>
        </select>
      </div>

      <div class="col-md-12">
        <button class="btn btn-accent w-100">üîç Filtrar</button>
      </div>
    </form>
    
    <form method="POST" action="{{ url_for('exportar_estado_piezas_excel') }}" class="mt-3">
        <input type="hidden" name="empresa" value="{{ empresa_sel or 'todos' }}">
        <input type="hidden" name="marco" value="{{ marco_sel or 'todos' }}">
        <input type="hidden" name="tramo" value="{{ tramo_sel or 'todos' }}">
        <input type="hidden" name="codigo_pieza" value="{{ codigo_sel or '' }}">
        <input type="hidden" name="estado" value="{{ estado_sel or 'todos' }}">
        <button class="btn btn-success w-100">üì• Exportar a Excel</button>
    </form>
  </div>
</div>

<!-- ================= TABLA ================= -->
{% if piezas %}
<div class="table-responsive mb-4">
  <table class="table table-dark table-striped align-middle">
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Cliente</th>
        <th>Marco</th>
        <th>Tramo</th>
        <th>C. Interna</th>
        <th>C. Externa</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      {% for p in piezas %}
      <tr>
        <td>{{ p.codigo }}</td>
        <td>{{ p.cliente }}</td>
        <td>{{ p.marco }}</td>
        <td>{{ p.tramo }}</td>
        <td>{{ p.cuerda_interna }}</td>
        <td>{{ p.cuerda_externa }}</td>
        <td>
            {{ p.estado }}
            {% if p.estado == 'Rematado' %}
             ‚úÖ
            {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-secondary text-center">No se encontraron resultados.</div>
{% endif %}

<script>
const selEmpresa = document.getElementById('empresa');
const selMarco = document.getElementById('marco');
const selTramo = document.getElementById('tramo');

function setOptions(selectEl, values) {
  const prev = selectEl.value;
  selectEl.innerHTML = '<option value="todos">Todos</option>';
  (values || []).forEach(v => selectEl.innerHTML += `<option value="${v}">${v}</option>`);
  if ([...selectEl.options].some(o => o.value === prev)) selectEl.value = prev;
}

selEmpresa && selEmpresa.addEventListener('change', async function() {
  const empresa = this.value;
  setOptions(selTramo, []);
  if (!empresa || empresa === 'todos') {
    // sin cliente: mantener marcos actuales
    return;
  }
  try {
    const res = await fetch(`/api/marcos/${encodeURIComponent(empresa)}`);
    const data = await res.json();
    setOptions(selMarco, data.marcos || []);
  } catch (e) {
    setOptions(selMarco, []);
  }
});

selMarco && selMarco.addEventListener('change', async function() {
  const empresa = selEmpresa.value;
  const marco = this.value;
  if (!empresa || empresa === 'todos' || !marco || marco === 'todos') {
    setOptions(selTramo, []);
    return;
  }
  try {
    const res = await fetch(`/api/tramos/${encodeURIComponent(empresa)}/${encodeURIComponent(marco)}`);
    const data = await res.json();
    setOptions(selTramo, data.tramos || []);
  } catch (e) {
    setOptions(selTramo, []);
  }
});

// Gr√°fico de Estado
document.addEventListener("DOMContentLoaded", function() {
    const canvas = document.getElementById('estadoChart');
    if (canvas) {
        const ctxEstado = canvas.getContext('2d');
        new Chart(ctxEstado, {
            type: 'doughnut',
            data: {
                labels: ['Sin Producci√≥n', 'Armado', 'Rematado'],
                datasets: [{
                    data: [
                        {{ stats.sin_produccion }}, 
                        {{ stats.armado }}, 
                        {{ stats.rematado }}
                    ],
                    backgroundColor: [
                        '#6c757d', // secondary (gris)
                        '#ffc107', // warning (amarillo)
                        '#198754'  // success (verde)
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Total Piezas: {{ stats.total }}',
                        color: '#f8f9fa',
                        font: { size: 16 }
                    }
                }
            }
        });
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
