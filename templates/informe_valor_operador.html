{% extends 'base.html' %}
{% block title %}Valor por Operador{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Informe ‚Äì Valor por Operador</h2>

  <!-- BOT√ìN VOLVER ARRIBA -->
  <a href="{{ url_for('admin_informes') }}" class="btn btn-secondary">
    ‚Üê Volver a Informes
  </a>
</div>

<div class="card bg-dark border-light shadow mb-4">
  <div class="card-body">

    <!-- FILTROS -->
    <form method="POST" class="row g-3">

      <div class="col-md-4">
        <label class="form-label text-light">Operador</label>
        <select name="operador" class="form-select">
          <option value="todos">Todos</option>
          {% for op in operadores %}
            <option value="{{ op }}" {% if operador_sel == op %}selected{% endif %}>
              {{ op }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Fecha inicio</label>
        <input type="date" name="fecha_inicio" value="{{ fecha_inicio }}" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label text-light">Fecha fin</label>
        <input type="date" name="fecha_fin" value="{{ fecha_fin }}" class="form-control">
      </div>

      <div class="col-md-12">
        <button class="btn btn-accent w-100">üîç Filtrar</button>
      </div>
    </form>

    <!-- EXPORTAR -->
    <form class="mt-3" method="POST" action="{{ url_for('exportar_valor_operador_excel') }}">
      <input type="hidden" name="operador" value="{{ operador_sel or 'todos' }}">
      <input type="hidden" name="fecha_inicio" value="{{ fecha_inicio or '' }}">
      <input type="hidden" name="fecha_fin" value="{{ fecha_fin or '' }}">
      <button class="btn btn-success w-100">üì• Exportar a Excel</button>
    </form>

  </div>
</div>

<!-- TABLA -->
{% if piezas %}
<div class="table-responsive mt-3">
  <table class="table table-dark table-striped align-middle">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>C√≥digo</th>
        <th>Cliente</th>
        <th>Operador</th>
        <th>Marco</th>
        <th>Tramo</th>
        <th>Modo</th>
        <th>Peso (kg)</th>
        <th>Valor ($)</th>
      </tr>
    </thead>

    <tbody>
      {% for p in piezas %}
      <tr>
        <td>{{ p.fecha.strftime("%d-%m-%Y %H:%M") if p.fecha else "‚Äî" }}</td>
        <td>{{ p.codigo }}</td>
        <td>{{ p.empresa }}</td>
        <td>{{ p.operador }}</td>
        <td>{{ p.marco }}</td>
        <td>{{ p.tramo }}</td>
        <td>{{ p.modo }}</td>
        <td>{{ "%.2f"|format(p.peso) }}</td>
        <td>${{ "%.0f"|format(p.valor) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- TOTAL GENERAL -->
<div class="text-end mt-3">
  <h4 class="text-light">
    Total general: 
    <span class="text-accent">${{ "%.0f"|format(total_general) }}</span>
  </h4>
</div>

{% else %}
  <div class="alert alert-secondary text-center">
    No se encontraron registros con esos filtros.
  </div>
{% endif %}

{% endblock %}
