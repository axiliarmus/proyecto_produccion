{% extends 'base.html' %}
{% block title %}Operador{% endblock %}
{% block content %}

<h2 class="mb-3">Operador · {{ nombre }}</h2>

<div class="d-flex gap-2 mb-4">
  <form method="post" action="{{ url_for('operador_ingreso') }}">
    <button class="btn btn-success">Marcar Ingreso</button>
  </form>
  <form method="post" action="{{ url_for('operador_salida') }}">
    <button class="btn btn-danger">Marcar Salida</button>
  </form>
</div>

<div class="card shadow mb-4">
  <div class="card-body">

    <h5 class="mb-3">Registrar nueva pieza</h5>

    <form class="row g-3" method="post" action="{{ url_for('operador_registrar') }}">

      <!-- MODO -->
      <div class="col-md-3">
        <label class="form-label">Modo</label>
        <select class="form-select" name="modo" id="modo" required>
          <option value="armador">Armador</option>
          <option value="rematador">Rematador</option>
        </select>
      </div>

      <!-- BOX -->
      <div class="col-md-3">
        <label class="form-label">Box</label>
        <select class="form-select" name="box" required>
          <option value="" selected disabled>Seleccione...</option>
          {% for b in boxes %}
            <option value="{{ b.codigo }}">{{ b.codigo }} - {{ b.descripcion }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- CÓDIGO DE PIEZA -->
      <div class="col-md-4">
        <label class="form-label">Código de pieza</label>
        <input class="form-control" name="codigo_pieza" placeholder="Ej: 101" required>
      </div>

      <!-- SECCIÓN DE CUERDAS (solo armador) -->
      <div id="cuerdas_section" style="display:block;">
        
        <div class="col-md-3">
          <label class="form-label">Cuerda interna</label>
          <input class="form-control" name="cuerda_interna" step="0.01" type="number">
        </div>

        <div class="col-md-3">
          <label class="form-label">Cuerda externa</label>
          <input class="form-control" name="cuerda_externa" step="0.01" type="number">
        </div>

      </div>

      <div class="col-12">
        <button class="btn btn-accent">Registrar pieza</button>
      </div>

    </form>
  </div>
</div>

<h5 class="mb-2">Piezas producidas hoy</h5>

{% if piezas_hoy %}
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Código</th>
          <th>Modo</th>
          <th>Box</th>
          <th>Empresa</th>
          <th>Marco</th>
          <th>Tramo</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for p in piezas_hoy %}
        <tr>
          <td>{{ p.fecha.strftime('%H:%M:%S') }}</td>
          <td>{{ p.codigo_pieza }}</td>
          <td>{{ p.modo|capitalize }}</td>
          <td>{{ p.box }}</td>
          <td>{{ p.empresa }}</td>
          <td>{{ p.marco }}</td>
          <td>{{ p.tramo }}</td>
          <td>
            {% if p.calidad_status == 'aprobado' %}
              <span class="badge bg-success">Aprobado</span>
            {% elif p.calidad_status == 'rechazado' %}
              <span class="badge bg-danger">Rechazado</span>
            {% else %}
              <span class="badge bg-secondary">Pendiente</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-secondary">Aún no hay piezas registradas hoy.</div>
{% endif %}

{% if jornada %}
  <div class="mt-4 small text-secondary">
    Jornada iniciada: {{ jornada.ingreso }}
    {% if jornada.salida %} · salida: {{ jornada.salida }}{% endif %}
  </div>
{% endif %}

<!-- SCRIPT PARA MOSTRAR/OCULTAR CUERDAS -->
<script>
document.getElementById("modo").addEventListener("change", function () {
    let valor = this.value;
    let cuerdas = document.getElementById("cuerdas_section");

    if (valor === "armador") {
        cuerdas.style.display = "flex";
    } else {
        cuerdas.style.display = "none";
    }
});
</script>

{% endblock %}
