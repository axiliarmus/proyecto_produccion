{% extends 'base.html' %}
{% block title %}Operador{% endblock %}
{% block content %}

<h2 class="mb-3">Operador ¬∑ {{ nombre }}</h2>

<div class="d-flex gap-2 mb-4">
  <form method="post" action="{{ url_for('operador_ingreso') }}">
    <button class="btn btn-success">Marcar Ingreso</button>
  </form>
  <form method="post" action="{{ url_for('operador_salida') }}">
    <button class="btn btn-danger">Marcar Salida</button>
  </form>
</div>

<div class="card shadow mb-4">
  <div class="card-body">

    <h5 class="mb-3">Registrar nueva pieza</h5>

    <form class="row g-3" method="post" action="{{ url_for('operador_registrar') }}">

      <!-- MODO -->
      <div class="col-md-3">
        <label class="form-label">Modo</label>
        <select class="form-select" name="modo" id="modo" required>
          <option value="armador">Armador</option>
          <option value="rematador">Rematador</option>
        </select>
      </div>

      <!-- BOX -->
      <div class="col-md-3">
        <label class="form-label">Box</label>
        <select class="form-select" name="box" required>
          <option value="" selected disabled>Seleccione...</option>
          {% for b in boxes %}
            <option value="{{ b.codigo }}">{{ b.codigo }} - {{ b.descripcion }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- C√ìDIGO DE PIEZA (Input + Esc√°ner QR) -->
      <div class="col-md-4">
        <label class="form-label">C√≥digo de pieza</label>
        <div class="input-group">
          <input class="form-control" name="codigo_pieza" id="codigo_pieza_input" placeholder="Ej: A101" required>
          <button type="button" class="btn btn-outline-secondary" id="btn-scan-qr">
            üì∑ Barcode
          </button>
        </div>
      </div>

      <!-- SECCI√ìN DE CUERDAS (solo armador) -->
      <div id="cuerdas_section" class="row col-12 mt-2" style="display:flex;">
        
        <div class="col-md-3">
          <label class="form-label">Cuerda interna</label>
          <input class="form-control" name="cuerda_interna" step="0.01" type="number">
        </div>

        <div class="col-md-3">
          <label class="form-label">Cuerda externa</label>
          <input class="form-control" name="cuerda_externa" step="0.01" type="number">
        </div>

      </div>

      <div class="col-12 mt-4">
        <button class="btn btn-accent w-100 py-2 fw-bold">Registrar pieza</button>
      </div>

    </form>
  </div>
</div>

<!-- Modal para Esc√°ner QR -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Escanear C√≥digo de Barras</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="reader" style="width: 100%;"></div>
        <p class="mt-2 text-muted small">Apunta la c√°mara al c√≥digo de barras de la pieza</p>
        
        <!-- Debug Console Visible -->
        <div id="debug-console" class="text-start mt-3 p-2 bg-black text-warning small border border-warning" style="font-family: monospace; max-height: 150px; overflow-y: auto; display: none;">
            <div>> Listo para iniciar...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Mis Registros de Producci√≥n</h5>
</div>

<!-- Filtro de Fechas -->
<div class="card bg-dark border-light shadow mb-4">
  <div class="card-body p-3">
    <form method="POST" action="{{ url_for('operador_home') }}" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label text-light small">Desde</label>
        <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ fecha_inicio }}">
      </div>
      <div class="col-md-4">
        <label class="form-label text-light small">Hasta</label>
        <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ fecha_fin }}">
      </div>
      <div class="col-md-4">
        <button class="btn btn-accent btn-sm w-100">Filtrar</button>
      </div>
    </form>
  </div>
</div>

{% if piezas_hoy %}
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>C√≥digo</th>
          <th>Marco</th>
          <th>Tramo</th>
          <th>Modo</th>
          <th>Valor Unit.</th>
          <th>Peso</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for p in piezas_hoy %}
        <tr>
          <td>{{ p.fecha.strftime('%d-%m-%Y %H:%M') }}</td>
          <td>{{ p.codigo_pieza }}</td>
          <td>{{ p.marco }}</td>
          <td>{{ p.tramo }}</td>
          <td>{{ p.modo|capitalize }}</td>
          <td>${{ "%.0f"|format(p.valor_calculado) }}</td>
          <td>{{ "%.2f"|format(p.peso_calculado) }}</td>
          <td>${{ "%.0f"|format(p.total_calculado) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="fw-bold bg-secondary">
          <td colspan="7" class="text-end">TOTAL GENERAL:</td>
          <td>${{ "%.0f"|format(total_general) }}</td>
        </tr>
      </tfoot>
    </table>
  </div>
{% else %}
  <div class="alert alert-secondary">No se encontraron registros en el rango seleccionado.</div>
{% endif %}

{% if jornada %}
  <div class="mt-4 small text-secondary">
    Jornada iniciada: {{ jornada.ingreso }}
    {% if jornada.salida %} ¬∑ salida: {{ jornada.salida }}{% endif %}
  </div>
{% endif %}

<!-- SCRIPT PARA MOSTRAR/OCULTAR CUERDAS Y ESC√ÅNER QR -->
<script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>
<script>
// L√≥gica de Cuerdas
document.getElementById("modo").addEventListener("change", function () {
    let valor = this.value;
    let cuerdas = document.getElementById("cuerdas_section");

    if (valor === "armador") {
        cuerdas.style.display = "flex";
    } else {
        cuerdas.style.display = "none";
    }
});

// Inicializar estado de cuerdas
document.getElementById("modo").dispatchEvent(new Event('change'));

// L√≥gica de Esc√°ner QR
let configHtml5QrCode = {};
if (typeof Html5QrcodeSupportedFormats !== 'undefined') {
    configHtml5QrCode = { 
        formatsToSupport: [ 
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A
        ]
    };
}

const html5QrCode = new Html5Qrcode("reader", configHtml5QrCode);
let qrModal; 
let isScanning = false;
const tunnelUrl = "{{ tunnel_url if tunnel_url else '' }}";

document.addEventListener('DOMContentLoaded', function() {
    if (typeof bootstrap !== 'undefined') {
        qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    } else {
        console.error("Bootstrap no est√° definido");
    }

    // Mostrar banner si hay t√∫nel disponible y estamos en HTTP
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1' && tunnelUrl) {
        const banner = document.createElement('div');
        banner.className = 'alert alert-warning fixed-top text-center m-0 shadow-lg';
        banner.style.zIndex = '9999';
        banner.innerHTML = `
           <div class="d-flex flex-column align-items-center gap-2">
               <strong>‚ö†Ô∏è MODO INSEGURO DETECTADO</strong>
               <span>La c√°mara no funcionar√° en esta direcci√≥n.</span>
               <a href="${tunnelUrl}/operador" class="btn btn-success fw-bold pulse-button">
                   üîí CAMBIAR A VERSI√ìN SEGURA
               </a>
           </div>
        `;
        document.body.prepend(banner);
        
        // Estilo para el bot√≥n pulsante
        const style = document.createElement('style');
        style.textContent = `
            .pulse-button { animation: pulse 1.5s infinite; }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    }
});

function debugLog(msg) {
    const consoleDiv = document.getElementById('debug-console');
    if (consoleDiv) {
        consoleDiv.style.display = 'block';
        const line = document.createElement('div');
        line.innerText = `> ${msg}`;
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }
    console.log(msg);
}

document.getElementById('btn-scan-qr').addEventListener('click', () => {
    debugLog("Bot√≥n presionado. Verificando entorno...");
    
    // Verificaci√≥n y ayuda para HTTP
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        
        if (tunnelUrl) {
            // Ofrecer cambio a versi√≥n segura autom√°ticamente
            const userWantsSecure = confirm(
                "‚ö†Ô∏è Est√°s en modo inseguro (HTTP) y la c√°mara fallar√°.\n\n" +
                "‚úÖ ¬°Hay una conexi√≥n segura lista!\n\n" +
                "¬øQuieres cambiar a la versi√≥n segura ahora?"
            );
            if (userWantsSecure) {
                // Redirigir a la misma ruta pero en el dominio seguro
                // tunnelUrl es base (ej: https://xyz.lhr.life)
                // location.pathname es /operador
                location.href = tunnelUrl + location.pathname;
                return;
            }
        }

        const mensaje = "‚ö†Ô∏è Est√°s usando HTTP. Si la c√°mara no abre, sigue estos pasos:\n\n" +
                        "1. Abre una nueva pesta√±a en Chrome y escribe: chrome://flags\n" +
                        "2. Busca: unsafely-treat-insecure-origin-as-secure\n" +
                        "3. Act√≠valo (Enabled) y agrega esta direcci√≥n: http://" + location.host + "\n" +
                        "4. Reinicia Chrome e intenta de nuevo.";
        
        debugLog("Advertencia: Protocolo inseguro detectado (HTTP).");
        console.warn("Advertencia HTTP: C√°mara podr√≠a estar bloqueada.");
    } else {
        debugLog("Protocolo seguro detectado.");
    }
    
    qrModal.show();
    
    // Peque√±o delay para asegurar que el modal est√© visible antes de iniciar
    setTimeout(() => {
        startScanning();
    }, 500);
});

document.getElementById('qrModal').addEventListener('hidden.bs.modal', () => {
    stopScanning();
});

function startScanning() {
    if (isScanning) return;
    isScanning = true;
    debugLog("Iniciando solicitud de c√°mara...");
    
    // Limpiar mensajes anteriores
    const readerDiv = document.getElementById('reader');
    
    // Primero intentamos listar c√°maras para ver si tenemos permisos
    Html5Qrcode.getCameras().then(devices => {
        debugLog(`C√°maras detectadas: ${devices.length}`);
        
        if (devices && devices.length) {
            let cameraId = devices[0].id;
            // Intentar buscar c√°mara trasera
            for (const device of devices) {
                if (device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('trasera') || device.label.toLowerCase().includes('environment')) {
                    cameraId = device.id;
                    debugLog(`Usando c√°mara trasera: ${device.label}`);
                    break;
                }
            }
            
            // Iniciar con ID de c√°mara espec√≠fico
            html5QrCode.start(
                cameraId, 
                {
                    fps: 10,
                    qrbox: { width: 300, height: 150 }
                },
                (decodedText, decodedResult) => {
                    debugLog("¬°C√≥digo detectado!");
                    document.getElementById('codigo_pieza_input').value = decodedText;
                    if (navigator.vibrate) navigator.vibrate(200);
                    stopScanning();
                    qrModal.hide();
                },
                (errorMessage) => {
                    // Ignorar errores de frame vac√≠o
                }
            ).catch(err => {
                isScanning = false;
                debugLog(`ERROR al iniciar stream: ${err}`);
                mostrarErrorUI(readerDiv, err);
            });
            
        } else {
            isScanning = false;
            debugLog("ERROR: Lista de c√°maras vac√≠a.");
            mostrarErrorUI(readerDiv, "No se encontraron c√°maras.");
        }
    }).catch(err => {
        isScanning = false;
        debugLog(`ERROR CR√çTICO (Permisos/HTTPS): ${err}`);
        mostrarErrorUI(readerDiv, err);
    });
}

function mostrarErrorUI(container, err) {
    const esHttp = location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1';
    let msgExtra = "";
    
    if (esHttp) {
        msgExtra = `
        <div class="mt-3 text-start small border p-2 bg-dark">
            <strong>Soluci√≥n para HTTP (Chrome/Android):</strong><br>
            1. Ve a <code>chrome://flags</code><br>
            2. Busca <code>unsafely-treat-insecure-origin-as-secure</code><br>
            3. Act√≠valo y agrega: <code>http://${location.host}</code><br>
            4. Reinicia Chrome.
        </div>`;
    }

    container.innerHTML = `
        <div class="alert alert-danger">
            <strong>No se pudo iniciar la c√°mara.</strong><br>
            <small>${err}</small><br><br>
            Posibles causas:<br>
            1. No diste permiso a la c√°mara.<br>
            2. Est√°s usando HTTP sin configurar excepciones.<br>
            3. Otra aplicaci√≥n est√° usando la c√°mara.
        </div>
        ${msgExtra}
        <button class="btn btn-outline-light btn-sm mt-2" onclick="location.reload()">Recargar p√°gina</button>
    `;
}

function stopScanning() {
    if (isScanning) {
        debugLog("Deteniendo c√°mara...");
        html5QrCode.stop().then(() => {
            isScanning = false;
            html5QrCode.clear();
            debugLog("C√°mara detenida.");
        }).catch(err => {
            console.error("Error al detener c√°mara", err);
        });
    }
}
</script>

{% endblock %}
