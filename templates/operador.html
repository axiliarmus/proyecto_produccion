{% extends 'base.html' %}
{% block title %}Operador{% endblock %}
{% block content %}

<h2 class="mb-3">Operador 췅 {{ nombre }}</h2>

<div class="d-flex gap-2 mb-4">
  <form method="post" action="{{ url_for('operador_ingreso') }}">
    <button class="btn btn-success">Marcar Ingreso</button>
  </form>
  <form method="post" action="{{ url_for('operador_salida') }}">
    <button class="btn btn-danger">Marcar Salida</button>
  </form>
</div>

<div class="card shadow mb-4">
  <div class="card-body">

    <h5 class="mb-3">Registrar nueva pieza</h5>

    <form class="row g-3" method="post" action="{{ url_for('operador_registrar') }}">

      <!-- MODO -->
      <div class="col-md-3">
        <label class="form-label">Modo</label>
        <select class="form-select" name="modo" id="modo" required>
          <option value="armador">Armador</option>
          <option value="rematador">Rematador</option>
        </select>
      </div>

      <!-- BOX -->
      <div class="col-md-3">
        <label class="form-label">Box</label>
        <select class="form-select" name="box" required>
          <option value="" selected disabled>Seleccione...</option>
          {% for b in boxes %}
            <option value="{{ b.codigo }}">{{ b.codigo }} - {{ b.descripcion }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- C칍DIGO DE PIEZA (Input + Esc치ner QR) -->
      <div class="col-md-4">
        <label class="form-label">C칩digo de pieza</label>
        <div class="input-group">
          <input class="form-control" name="codigo_pieza" id="codigo_pieza_input" placeholder="Ej: A101" required>
          <button type="button" class="btn btn-outline-secondary" id="btn-scan-qr">
            游닝 Barcode
          </button>
        </div>
      </div>

      <!-- SECCI칍N DE CUERDAS (solo armador) -->
      <div id="cuerdas_section" class="row col-12 mt-2" style="display:flex;">
        
        <div class="col-md-3">
          <label class="form-label">Cuerda interna</label>
          <input class="form-control" name="cuerda_interna" step="0.01" type="number">
        </div>

        <div class="col-md-3">
          <label class="form-label">Cuerda externa</label>
          <input class="form-control" name="cuerda_externa" step="0.01" type="number">
        </div>

      </div>

      <div class="col-12 mt-4">
        <button class="btn btn-accent w-100 py-2 fw-bold">Registrar pieza</button>
      </div>

    </form>
  </div>
</div>

<!-- Modal para Esc치ner QR -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Escanear C칩digo de Barras</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="reader" style="width: 100%;"></div>
        <p class="mt-2 text-muted small">Apunta la c치mara al c칩digo de barras de la pieza</p>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Mis Registros de Producci칩n</h5>
</div>

<!-- Filtro de Fechas -->
<div class="card bg-dark border-light shadow mb-4">
  <div class="card-body p-3">
    <form method="POST" action="{{ url_for('operador_home') }}" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label text-light small">Desde</label>
        <input type="date" name="fecha_inicio" class="form-control form-control-sm" value="{{ fecha_inicio }}">
      </div>
      <div class="col-md-4">
        <label class="form-label text-light small">Hasta</label>
        <input type="date" name="fecha_fin" class="form-control form-control-sm" value="{{ fecha_fin }}">
      </div>
      <div class="col-md-4">
        <button class="btn btn-accent btn-sm w-100">Filtrar</button>
      </div>
    </form>
  </div>
</div>

{% if piezas_hoy %}
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>C칩digo</th>
          <th>Marco</th>
          <th>Tramo</th>
          <th>Modo</th>
          <th>Valor Unit.</th>
          <th>Peso</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for p in piezas_hoy %}
        <tr>
          <td>{{ p.fecha.strftime('%d-%m-%Y %H:%M') }}</td>
          <td>{{ p.codigo_pieza }}</td>
          <td>{{ p.marco }}</td>
          <td>{{ p.tramo }}</td>
          <td>{{ p.modo|capitalize }}</td>
          <td>${{ "%.0f"|format(p.valor_calculado) }}</td>
          <td>{{ "%.2f"|format(p.peso_calculado) }}</td>
          <td>${{ "%.0f"|format(p.total_calculado) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="fw-bold bg-secondary">
          <td colspan="7" class="text-end">TOTAL GENERAL:</td>
          <td>${{ "%.0f"|format(total_general) }}</td>
        </tr>
      </tfoot>
    </table>
  </div>
{% else %}
  <div class="alert alert-secondary">No se encontraron registros en el rango seleccionado.</div>
{% endif %}

{% if jornada %}
  <div class="mt-4 small text-secondary">
    Jornada iniciada: {{ jornada.ingreso }}
    {% if jornada.salida %} 췅 salida: {{ jornada.salida }}{% endif %}
  </div>
{% endif %}

<!-- SCRIPT PARA MOSTRAR/OCULTAR CUERDAS Y ESC츼NER QR -->
<script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>
<script>
// L칩gica de Cuerdas
document.getElementById("modo").addEventListener("change", function () {
    let valor = this.value;
    let cuerdas = document.getElementById("cuerdas_section");

    if (valor === "armador") {
        cuerdas.style.display = "flex";
    } else {
        cuerdas.style.display = "none";
    }
});

// Inicializar estado de cuerdas
document.getElementById("modo").dispatchEvent(new Event('change'));

// L칩gica de Esc치ner QR
const html5QrCode = new Html5Qrcode("reader", { 
    formatsToSupport: [ 
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.CODE_39,
        Html5QrcodeSupportedFormats.UPC_A
    ]
});
const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
let isScanning = false;

document.getElementById('btn-scan-qr').addEventListener('click', () => {
    // Verificaci칩n de HTTPS para m칩viles
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        alert("丘멆잺 Advertencia de Seguridad: El navegador de tu celular podr칤a bloquear la c치mara porque no est치s usando una conexi칩n segura (HTTPS).\n\nSi la c치mara no se abre, intenta acceder usando 'https://' o configura tu navegador.");
    }
    
    qrModal.show();
    startScanning();
});

document.getElementById('qrModal').addEventListener('hidden.bs.modal', () => {
    stopScanning();
});

function startScanning() {
    if (isScanning) return;
    isScanning = true;
    
    // Limpiar mensajes anteriores
    const readerDiv = document.getElementById('reader');
    
    html5QrCode.start(
        { facingMode: "environment" }, 
        {
            fps: 10,
            qrbox: { width: 300, height: 150 }
        },
        (decodedText, decodedResult) => {
            // Success callback
            document.getElementById('codigo_pieza_input').value = decodedText;
            
            // Feedback visual de 칠xito (vibraci칩n si es posible)
            if (navigator.vibrate) navigator.vibrate(200);
            
            stopScanning();
            qrModal.hide();
        },
        (errorMessage) => {
            // Error callback (ignorar errores de lectura continua)
        }
    ).catch(err => {
        console.error("Error al iniciar c치mara", err);
        isScanning = false;
        
        // Mostrar error amigable al usuario
        readerDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>No se pudo iniciar la c치mara.</strong><br>
                <small>${err}</small><br><br>
                Posibles causas:<br>
                1. No diste permiso a la c치mara.<br>
                2. Est치s usando HTTP en lugar de HTTPS.<br>
                3. Otra aplicaci칩n est치 usando la c치mara.
            </div>
            <button class="btn btn-outline-light btn-sm mt-2" onclick="location.reload()">Recargar p치gina</button>
        `;
    });
}

function stopScanning() {
    if (isScanning) {
        html5QrCode.stop().then(() => {
            isScanning = false;
            html5QrCode.clear();
        }).catch(err => {
            console.error("Error al detener c치mara", err);
        });
    }
}
</script>

{% endblock %}
