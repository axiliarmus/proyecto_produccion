{% extends 'base.html' %}
{% block title %}Piezas Sin Producci√≥n{% endblock %}

{% block content %}

<h2 class="mb-4">Informe ‚Äì Piezas Sin Producci√≥n</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="text-secondary mb-0">
    Lista de piezas que a√∫n no han sido armadas ni rematadas.
  </p>

  <a href="{{ url_for('admin_informes') }}" class="btn btn-secondary">
    ‚Üê Volver a Informes
  </a>
</div>

<!-- ================= FILTROS ================= -->

<div class="card bg-dark border-light shadow mb-4">
  <div class="card-body">

    <form method="POST" class="row g-3">

      <div class="col-md-4">
        <label class="form-label text-light">Cliente</label>
        <select name="empresa" id="empresa" class="form-select">
          <option value="todos" {% if not empresa_sel or empresa_sel=='todos' %}selected{% endif %}>Todos</option>
          {% for e in empresas %}
            <option value="{{ e }}" {% if empresa_sel==e %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label text-light">Marco</label>
        <select name="marco" id="marco" class="form-select">
          <option value="todos" {% if not marco_sel or marco_sel=='todos' %}selected{% endif %}>Todos</option>
          {% for m in marcos %}
            <option value="{{ m }}" {% if marco_sel==m %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label text-light">Tramo</label>
        <select name="tramo" id="tramo" class="form-select">
          <option value="todos" {% if not tramo_sel or tramo_sel=='todos' %}selected{% endif %}>Todos</option>
          {% for t in tramos %}
            <option value="{{ t }}" {% if tramo_sel==t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12">
        <button class="btn btn-accent w-100">üîç Filtrar</button>
      </div>
    </form>

    <!-- EXPORTAR -->
    <form class="mt-3" method="POST" action="{{ url_for('exportar_piezas_sin_produccion_excel') }}">
      <input type="hidden" name="empresa" value="{{ empresa_sel }}">
      <input type="hidden" name="marco" value="{{ marco_sel }}">
      <input type="hidden" name="tramo" value="{{ tramo_sel }}">
      <button class="btn btn-success w-100">üì• Exportar a Excel</button>
    </form>

  </div>
</div>

<script>
const ALL_MARCOS = {{ marcos|tojson }};
const ALL_TRAMOS = {{ tramos|tojson }};

const selEmpresa = document.getElementById('empresa');
const selMarco = document.getElementById('marco');
const selTramo = document.getElementById('tramo');

function setOptions(selectEl, values, includeTodos=true) {
  const prev = selectEl.value;
  selectEl.innerHTML = '';
  if (includeTodos) {
    selectEl.innerHTML += `<option value="todos">Todos</option>`;
  }
  values.forEach(v => {
    selectEl.innerHTML += `<option value="${v}">${v}</option>`;
  });
  // intenta preservar selecci√≥n si existe
  if ([...selectEl.options].some(o => o.value === prev)) selectEl.value = prev;
}

selEmpresa.addEventListener('change', async function() {
  const empresa = this.value;
  selMarco.disabled = true;
  selTramo.disabled = true;
  setOptions(selTramo, [], true);

  if (!empresa || empresa === 'todos') {
    setOptions(selMarco, ALL_MARCOS, true);
    selMarco.disabled = false;
    selTramo.disabled = false;
    return;
  }

  try {
    const res = await fetch(`/api/marcos/${encodeURIComponent(empresa)}`);
    const data = await res.json();
    setOptions(selMarco, data.marcos || [], true);
    selMarco.disabled = false;
  } catch (e) {
    setOptions(selMarco, [], true);
    selMarco.disabled = false;
  }
});

selMarco.addEventListener('change', async function() {
  const empresa = selEmpresa.value;
  const marco = this.value;
  selTramo.disabled = true;

  if (!empresa || empresa === 'todos') {
    // sin empresa espec√≠fica: mostrar todos los tramos
    setOptions(selTramo, ALL_TRAMOS, true);
    selTramo.disabled = false;
    return;
  }
  if (!marco || marco === 'todos') {
    setOptions(selTramo, [], true);
    selTramo.disabled = false;
    return;
  }
  try {
    const res = await fetch(`/api/tramos/${encodeURIComponent(empresa)}/${encodeURIComponent(marco)}`);
    const data = await res.json();
    setOptions(selTramo, data.tramos || [], true);
    selTramo.disabled = false;
  } catch (e) {
    setOptions(selTramo, [], true);
    selTramo.disabled = false;
  }
});
</script>

<!-- ================= TABLA ================= -->

{% if piezas %}

<div class="table-responsive mb-4">
  <table class="table table-dark table-striped align-middle">
    <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Cliente</th>
        <th>Marco</th>
        <th>Tramo</th>
      </tr>
    </thead>

    <tbody>
      {% for p in piezas %}
      <tr>
        <td>{{ p.codigo }}</td>
        <td>{{ p.empresa }}</td>
        <td>{{ p.marco }}</td>
        <td>{{ p.tramo }}</td>
      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

{% else %}

<div class="alert alert-secondary text-center">
  No se encontraron piezas sin producci√≥n con estos filtros.
</div>

{% endif %}

{% endblock %}
