{% extends 'admin_layout.html' %}

{% block title %}Picking de Piezas{% endblock %}
{% block header_title %}Picking y Conteo{% endblock %}
{% block header_subtitle %}Escaneo y verificaci√≥n de piezas en planta{% endblock %}

{% block content %}

<div class="row g-4">
    <!-- SECCI√ìN DE ESCANEO -->
    <div class="col-lg-4">
        <div class="admin-card mb-4 sticky-top" style="top: 20px; z-index: 100;">
            <h5 class="text-white mb-3">üì∏ Esc√°ner</h5>
            
            <button class="btn btn-accent w-100 mb-3 d-flex align-items-center justify-content-center gap-2" id="btn-scan-qr">
                <i class='bx bx-camera fs-4'></i> Activar C√°mara
            </button>
            
            <hr class="border-secondary my-4">
            
            <h5 class="text-white mb-3">‚å®Ô∏è Ingreso Manual</h5>
            <div class="input-group mb-3">
                <input type="text" id="manualInput" class="form-control bg-dark text-light border-secondary" placeholder="C√≥digo de pieza..." autocomplete="off">
                <button class="btn btn-secondary" type="button" id="manualBtn"><i class='bx bx-plus'></i></button>
            </div>

            <!-- √öltima pieza escaneada -->
            <div id="lastScannedCard" class="alert alert-secondary d-none">
                <div class="d-flex justify-content-between">
                    <strong id="lastCode"></strong>
                    <span id="lastStatus" class="badge bg-dark"></span>
                </div>
                <small id="lastInfo" class="d-block mt-1 text-muted"></small>
            </div>
            
            <div class="d-grid gap-2 mt-4">
                 <button class="btn btn-outline-danger btn-sm" onclick="resetPicking()">
                    <i class='bx bx-trash'></i> Reiniciar Conteo
                 </button>
            </div>
        </div>
    </div>

    <!-- SECCI√ìN DE RESULTADOS -->
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="text-white mb-0">üì¶ Resumen del Picking</h5>
            <span class="badge bg-primary fs-6" id="totalCount">0 Piezas</span>
        </div>

        <!-- Contenedor de Tarjetas -->
        <div id="resultsContainer">
            <div class="text-center py-5 text-secondary">
                <i class='bx bx-barcode-reader fs-1 mb-3'></i>
                <p>Escanea piezas para comenzar el conteo.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Esc√°ner QR (Igual que Operador) -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Escanear C√≥digo de Barras</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="reader" style="width: 100%;"></div>
        <p class="mt-2 text-muted small">Apunta la c√°mara al c√≥digo de barras de la pieza</p>
      </div>
    </div>
  </div>
</div>

<!-- SONIDOS -->
<audio id="soundSuccess" src="https://cdn.freesound.org/previews/341/341695_5858296-lq.mp3"></audio>
<audio id="soundError" src="https://cdn.freesound.org/previews/142/142608_1840739-lq.mp3"></audio>
<audio id="soundDuplicate" src="https://cdn.freesound.org/previews/350/350861_6436536-lq.mp3"></audio>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>
<script>
// ESTADO DE LA APLICACI√ìN
const state = {
    scannedCodes: new Set({{ scanned_codes|tojson }}),
    data: {{ initial_data|tojson }}
};

// ELEMENTOS DOM
const manualInput = document.getElementById('manualInput');
const manualBtn = document.getElementById('manualBtn');
const resultsContainer = document.getElementById('resultsContainer');
const totalCountBadge = document.getElementById('totalCount');
const lastScannedCard = document.getElementById('lastScannedCard');
const lastCodeSpan = document.getElementById('lastCode');
const lastStatusSpan = document.getElementById('lastStatus');
const lastInfoSpan = document.getElementById('lastInfo');
const tunnelUrl = "{{ tunnel_url if tunnel_url else '' }}";

// Inicializar UI con datos del servidor
document.addEventListener('DOMContentLoaded', () => {
    updateUI();
    checkSecureConnection();
});

// AUDIO
const playSound = (type) => {
    const audio = document.getElementById(type === 'success' ? 'soundSuccess' : (type === 'duplicate' ? 'soundDuplicate' : 'soundError'));
    if(audio) {
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Audio play error", e));
    }
};

// L√ìGICA DE NEGOCIO (Picking)
async function processCode(code) {
    code = code.trim(); // Se elimina toUpperCase() para respetar input original
    if (!code) return;

    // 1. Verificar duplicado (Case Insensitive en frontend tambi√©n)
    const codeUpper = code.toUpperCase();
    let isDuplicate = false;
    state.scannedCodes.forEach(c => {
        if (c.toUpperCase() === codeUpper) isDuplicate = true;
    });

    if (isDuplicate) {
        playSound('duplicate');
        alert(`‚ö†Ô∏è ¬°La pieza ${code} YA FUE ESCANEADA!`);
        return;
    }

    // 2. Consultar API
    try {
        const res = await fetch('/api/picking/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ codigo: code })
        });
        
        const data = await res.json();

        if (!data.success) {
            playSound('error');
            alert(`‚ùå Error: ${data.message}`);
            return;
        }

        // 3. Agregar a estado (Usar el c√≥digo CAN√ìNICO devuelto por el servidor)
        const canonicalCode = data.pieza.codigo;
        state.scannedCodes.add(canonicalCode);
        addToData(data.pieza, data.estado);
        
        // 4. Actualizar UI
        updateUI();
        showLastScanned(data.pieza, data.estado);
        playSound('success');

    } catch (e) {
        console.error(e);
        playSound('error');
        alert("Error de conexi√≥n con el servidor.");
    }
}

function addToData(pieza, estado) {
    const { empresa, marco, tramo } = pieza;
    
    if (!state.data[empresa]) state.data[empresa] = {};
    if (!state.data[empresa][marco]) state.data[empresa][marco] = {};
    if (!state.data[empresa][marco][tramo]) {
        state.data[empresa][marco][tramo] = { armado: 0, rematado: 0, sin_prod: 0, total: 0 };
    }

    const counter = state.data[empresa][marco][tramo];
    counter.total++;
    
    if (estado === 'Armado') counter.armado++;
    else if (estado === 'Rematado') counter.rematado++;
    else counter.sin_prod++;
}

function updateUI() {
    totalCountBadge.textContent = `${state.scannedCodes.size} Piezas`;
    
    if (state.scannedCodes.size === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center py-5 text-secondary">
                <i class='bx bx-barcode-reader fs-1 mb-3'></i>
                <p>Escanea piezas para comenzar el conteo.</p>
            </div>`;
        return;
    }

    let html = '';
    
    for (const [cliente, marcos] of Object.entries(state.data)) {
        html += `<h5 class="text-accent mt-4 mb-3"><i class='bx bxs-business'></i> ${cliente}</h5>`;
        html += `<div class="row row-cols-1 row-cols-md-2 g-3">`;
        
        for (const [marco, tramos] of Object.entries(marcos)) {
            html += `
            <div class="col">
                <div class="admin-card h-100 p-3">
                    <h6 class="text-white border-bottom border-secondary pb-2 mb-3">${marco}</h6>
                    <table class="table table-dark table-sm mb-0">
                        <thead>
                            <tr class="text-secondary small">
                                <th>Tramo</th>
                                <th class="text-center text-warning">Arm</th>
                                <th class="text-center text-success">Rem</th>
                                <th class="text-center text-secondary">Sin</th>
                                <th class="text-end text-white">Total</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            for (const [tramo, counts] of Object.entries(tramos)) {
                html += `
                <tr>
                    <td>${tramo}</td>
                    <td class="text-center text-warning">${counts.armado || '-'}</td>
                    <td class="text-center text-success">${counts.rematado || '-'}</td>
                    <td class="text-center text-secondary">${counts.sin_prod || '-'}</td>
                    <td class="text-end fw-bold text-white">${counts.total}</td>
                </tr>`;
            }
            
            html += `</tbody></table></div></div>`;
        }
        html += `</div>`;
    }
    
    resultsContainer.innerHTML = html;
}

function showLastScanned(pieza, estado) {
    lastScannedCard.classList.remove('d-none');
    lastScannedCard.className = `alert mt-3 ${estado === 'Rematado' ? 'alert-success' : (estado === 'Armado' ? 'alert-warning' : 'alert-secondary')}`;
    
    lastCodeSpan.textContent = pieza.codigo;
    lastStatusSpan.textContent = estado;
    lastStatusSpan.className = `badge ${estado === 'Rematado' ? 'bg-success' : (estado === 'Armado' ? 'bg-warning text-dark' : 'bg-secondary')}`;
    
    lastInfoSpan.textContent = `${pieza.empresa} - ${pieza.marco} - ${pieza.tramo}`;
}

function resetPicking() {
    if(confirm("¬øEst√°s seguro de borrar todo el conteo actual?")) {
        fetch('/api/picking/reset', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                state.scannedCodes.clear();
                state.data = {};
                updateUI();
                lastScannedCard.classList.add('d-none');
            } else {
                alert("Error al reiniciar: " + data.message);
            }
        });
    }
}

// EVENTOS MANUALES
manualBtn.addEventListener('click', () => {
    processCode(manualInput.value);
    manualInput.value = '';
    manualInput.focus();
});

manualInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        processCode(manualInput.value);
        manualInput.value = '';
    }
});

// ============================================================
// L√ìGICA DE ESC√ÅNER ROBUSTA (C√ÅMARA TRASERA + HTTPS)
// ============================================================

let configHtml5QrCode = {};
if (typeof Html5QrcodeSupportedFormats !== 'undefined') {
    configHtml5QrCode = { 
        formatsToSupport: [ 
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A
        ]
    };
}

const html5QrCode = new Html5Qrcode("reader", configHtml5QrCode);
let isScanning = false;
let qrModal;

document.addEventListener('DOMContentLoaded', function() {
    updateUI();
    checkSecureConnection();
    // Inicializar Modal
    if (typeof bootstrap !== 'undefined') {
        qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    } else {
        console.error("Bootstrap no est√° definido");
    }
});

function checkSecureConnection() {
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1' && tunnelUrl) {
        const banner = document.createElement('div');
        banner.className = 'alert alert-warning fixed-top text-center m-0 shadow-lg';
        banner.style.zIndex = '9999';
        banner.innerHTML = `
           <div class="d-flex flex-column align-items-center gap-2">
               <strong>‚ö†Ô∏è MODO INSEGURO DETECTADO</strong>
               <span>La c√°mara no funcionar√° en esta direcci√≥n.</span>
               <a href="${tunnelUrl}/admin/picking" class="btn btn-success fw-bold pulse-button">
                   üîí CAMBIAR A VERSI√ìN SEGURA
               </a>
           </div>
        `;
        document.body.prepend(banner);
        
        const style = document.createElement('style');
        style.textContent = `
            .pulse-button { animation: pulse 1.5s infinite; }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    }
}

document.getElementById('btn-scan-qr').addEventListener('click', () => {
    // Diagn√≥stico
    console.log("Bot√≥n c√°mara presionado");
    
    if (typeof Html5Qrcode === 'undefined') {
        alert("Error: Librer√≠a de esc√°ner no cargada. Recarga la p√°gina.");
        return;
    }

    if (!qrModal) {
        // Intentar reinicializar
        if (typeof bootstrap !== 'undefined') {
            const el = document.getElementById('qrModal');
            if (el) qrModal = new bootstrap.Modal(el);
        }
    }

    if (!qrModal) {
        alert("Error: No se pudo iniciar el componente Modal.");
        return;
    }

    // Verificaci√≥n de seguridad antes de iniciar
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
        if (tunnelUrl) {
            const userWantsSecure = confirm(
                "‚ö†Ô∏è Est√°s en modo inseguro (HTTP) y la c√°mara fallar√°.\n\n" +
                "‚úÖ ¬°Hay una conexi√≥n segura lista!\n\n" +
                "¬øQuieres cambiar a la versi√≥n segura ahora?"
            );
            if (userWantsSecure) {
                location.href = tunnelUrl + location.pathname;
                return;
            }
        }
    }

    qrModal.show();
    
    // Peque√±o delay para asegurar que el modal est√© visible antes de iniciar
    setTimeout(() => {
        startScanning();
    }, 500);
});

// Detener escaneo al cerrar modal
document.getElementById('qrModal').addEventListener('hidden.bs.modal', () => {
    stopScanning();
});

function startScanning() {
    if (isScanning) return;
    
    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            let cameraId = devices[0].id;
            // Preferir c√°mara trasera
            for (const device of devices) {
                if (device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('trasera') || device.label.toLowerCase().includes('environment')) {
                    cameraId = device.id;
                    break;
                }
            }
            
            html5QrCode.start(
                cameraId, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // Pausa breve
                    html5QrCode.pause();
                    processCode(decodedText).then(() => {
                         // Cerrar modal tras escaneo exitoso (comportamiento Operador)
                         stopScanning();
                         qrModal.hide();
                    });
                },
                (errorMessage) => {
                    // Ignorar errores de frame vac√≠o
                }
            ).then(() => {
                isScanning = true;
            }).catch(err => {
                isScanning = false;
                const readerDiv = document.getElementById('reader');
                mostrarErrorUI(readerDiv, err);
            });
        } else {
            alert('No se encontraron c√°maras.');
        }
    }).catch(err => {
        const readerDiv = document.getElementById('reader');
        mostrarErrorUI(readerDiv, err);
    });
}

function stopScanning() {
    if (isScanning) {
        html5QrCode.stop().then(() => {
            isScanning = false;
            html5QrCode.clear();
        }).catch(err => {
            console.error("Error al detener c√°mara", err);
        });
    }
}

function mostrarErrorUI(container, err) {
    const esHttp = location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1';
    let msgExtra = "";
    
    if (esHttp) {
        msgExtra = `
        <div class="mt-3 text-start small border p-2 bg-dark text-white">
            <strong>Soluci√≥n para HTTP (Chrome/Android):</strong><br>
            1. Ve a <code>chrome://flags</code><br>
            2. Busca <code>unsafely-treat-insecure-origin-as-secure</code><br>
            3. Act√≠valo y agrega: <code>http://${location.host}</code><br>
            4. Reinicia Chrome.
        </div>`;
    }

    container.innerHTML = `
        <div class="alert alert-danger">
            <strong>No se pudo iniciar la c√°mara.</strong><br>
            <small>${err}</small><br><br>
            Posibles causas:<br>
            1. No diste permiso a la c√°mara.<br>
            2. Est√°s usando HTTP sin configurar excepciones.<br>
            3. Otra aplicaci√≥n est√° usando la c√°mara.
        </div>
        ${msgExtra}
        <button class="btn btn-outline-light btn-sm mt-2" onclick="location.reload()">Recargar p√°gina</button>
    `;
}
</script>
{% endblock %}