{% extends 'admin_layout.html' %}

{% block title %}Buscador Universal de Piezas{% endblock %}
{% block header_title %}Buscador Universal{% endblock %}
{% block header_subtitle %}Rastreo de historial completo (Activo + Archivo){% endblock %}

{% block content %}

<div class="card bg-dark border-light shadow mb-4">
    <div class="card-body">
        <form method="POST" class="row g-3 align-items-end">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
            <div class="col-md-9">
                <label class="form-label text-light">C√≥digo de Pieza</label>
                <input type="text" name="codigo" class="form-control form-control-lg bg-dark text-light border-secondary" 
                       placeholder="Ingresa el c√≥digo exacto..." value="{{ codigo or '' }}" required>
            </div>
            <div class="col-md-3">
                <button class="btn btn-warning w-100 btn-lg">üîç Buscar Historial</button>
            </div>
        </form>
    </div>
</div>

{% if codigo and not pieza_activa and not piezas_historicas %}
<div class="alert alert-danger text-center">
    No se encontr√≥ ninguna informaci√≥n para el c√≥digo <strong>{{ codigo }}</strong> ni en el sistema activo ni en los archivos hist√≥ricos.
</div>
{% endif %}

<!-- SECCI√ìN: PIEZA ACTIVA (SISTEMA ACTUAL) -->
{% if pieza_activa %}
<div class="card bg-dark border-success shadow mb-5">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">‚úÖ En Sistema Activo (Ciclo Actual)</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h5 class="text-accent">Detalles de la Pieza</h5>
                <ul class="list-group list-group-flush bg-transparent">
                    <li class="list-group-item bg-transparent text-light"><strong>Cliente:</strong> {{ pieza_activa.data.empresa }}</li>
                    <li class="list-group-item bg-transparent text-light"><strong>Marco:</strong> {{ pieza_activa.data.marco }}</li>
                    <li class="list-group-item bg-transparent text-light"><strong>Tramo:</strong> {{ pieza_activa.data.tramo }}</li>
                    <li class="list-group-item bg-transparent text-light"><strong>Estado Actual:</strong> 
                        <span class="badge bg-light text-dark">{{ pieza_activa.estado_actual }}</span>
                    </li>
                </ul>
            </div>
            <div class="col-md-8">
                <h5 class="text-accent">Historial de Producci√≥n (Actual)</h5>
                {% if pieza_activa.produccion %}
                <div class="table-responsive">
                    <table class="table table-sm table-dark table-bordered">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Operador</th>
                                <th>Acci√≥n</th>
                                <th>Box</th>
                                <th>Calidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prod in pieza_activa.produccion %}
                            <tr>
                                <td>{{ prod.fecha.strftime('%d-%m-%Y %H:%M') }}</td>
                                <td>{{ prod.usuario }}</td>
                                <td>
                                    {% if prod.modo == 'armador' %}
                                        <span class="badge bg-warning text-dark">Armado</span>
                                    {% else %}
                                        <span class="badge bg-success">Remate</span>
                                    {% endif %}
                                </td>
                                <td>{{ prod.box }}</td>
                                <td>{{ prod.calidad_status }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-secondary">Esta pieza est√° cargada en el sistema pero <strong>nadie la ha trabajado a√∫n</strong>.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- SECCI√ìN: ARCHIVO HIST√ìRICO -->
{% if piezas_historicas %}
<h3 class="text-light mb-3">üìÇ Historial de Archivos (Cortes Anteriores)</h3>
{% for ph in piezas_historicas %}
<div class="card bg-dark border-secondary shadow mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between">
        <h5 class="mb-0">üìÖ Corte: {{ ph.corte_nombre }}</h5>
        <span class="badge bg-dark">Estado al cierre: {{ ph.estado_cierre }}</span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-info">Datos en ese momento</h6>
                <p class="mb-1 text-secondary"><small>Cliente: {{ ph.data.empresa }}</small></p>
                <p class="mb-1 text-secondary"><small>Marco: {{ ph.data.marco }}</small></p>
                <p class="mb-1 text-secondary"><small>Tramo: {{ ph.data.tramo }}</small></p>
            </div>
            <div class="col-md-8">
                <h6 class="text-info">Registro de Producci√≥n en este Corte</h6>
                {% if ph.produccion %}
                <div class="table-responsive">
                    <table class="table table-sm table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Operador</th>
                                <th>Acci√≥n</th>
                                <th>Calidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prod in ph.produccion %}
                            <tr>
                                <td>{{ prod.fecha.strftime('%d-%m-%Y %H:%M') }}</td>
                                <td>{{ prod.usuario }}</td>
                                <td>{{ prod.modo|capitalize }}</td>
                                <td>{{ prod.calidad_status }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">En este corte, la pieza exist√≠a pero <strong>no registr√≥ producci√≥n</strong>.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

{% endblock %}